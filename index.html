<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Total Fitness — Auth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --bg: Canvas; --fg: CanvasText; --muted: rgba(0,0,0,.65); --accent:#2D2D2D; }
    @media (prefers-color-scheme: dark) { :root { --muted: rgba(255,255,255,.7); } }
    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .wrap { min-height:100svh; display:grid; place-items:center; padding:24px; }
    .card { width:100%; max-width:640px; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); background:var(--bg); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    p { margin:0 0 16px; color:var(--muted); }
    label { display:block; font-size:.8rem; font-weight:700; letter-spacing:.04em; margin:14px 0 6px; color:var(--muted); }
    input {
      width:100%; padding:14px; border-radius:10px;
      border:1px solid color-mix(in oklab, CanvasText 20%, transparent);
      background: color-mix(in oklab, Canvas 92%, CanvasText 0%);
      color:var(--fg);
    }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top:18px; }
    .btn { padding:12px 16px; border-radius:10px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer; }
    .btn.secondary { background:transparent; color:var(--fg); }
    .hint { margin-top:10px; font-size:.9rem; color:var(--muted); }
    .hidden { display:none !important; }
    .divider { margin-top:18px; padding-top:6px; border-top:1px solid color-mix(in oklab, CanvasText 14%, transparent); }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">Set a new password</h1>
    <p id="subtitle">Choose a strong password to secure your account.</p>

    <div id="statusScreen" class="hidden" style="text-align:center;">
      <div style="font-size:3rem; margin-bottom:12px;">⚠️</div>
      <p id="statusText"></p>
    </div>

    <form id="form" novalidate>
      <label>New password</label>
      <input id="pw1" type="password" minlength="8" autocomplete="new-password" />

      <label>Confirm password</label>
      <input id="pw2" type="password" minlength="8" autocomplete="new-password" />

      <div class="divider"></div>

      <div class="row">
        <button class="btn">Continue</button>
        <button type="button" class="btn secondary" id="clear">Clear</button>
      </div>

      <div id="msg" class="hint"></div>
    </form>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://amrjonpzbqerosyaklnq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcmpvbnB6YnFlcm9zeWFrbG5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzE4MzYsImV4cCI6MjA3NTQwNzgzNn0.DwinrwLJEPCldiyD7Fbr8QMtgJYAQvG2Q0nuqBotpDs";

  const h = new URLSearchParams(location.hash.replace("#",""));

  const token = h.get("access_token");
  const type = (h.get("type") || "").toLowerCase();
  const error = h.get("error");
  const errorCode = h.get("error_code");

  if (type) {
    sessionStorage.setItem("auth_flow", type);
  }

  const rememberedType = sessionStorage.getItem("auth_flow");
  const effectiveType = type || rememberedType || "";
  const isPasswordFlow = effectiveType === "invite" || effectiveType === "recovery";

  const form = document.getElementById("form");
  const statusScreen = document.getElementById("statusScreen");
  const statusText = document.getElementById("statusText");
  const title = document.getElementById("title");
  const subtitle = document.getElementById("subtitle");
  const msg = document.getElementById("msg");

  if (error || errorCode === "otp_expired") {
    title.textContent = "Link expired";
    subtitle.textContent = "";
    statusText.textContent = "This link is no longer valid. Please ask staff to send you a new login link.";
    form.classList.add("hidden");
    statusScreen.classList.remove("hidden");
  }
  else if (isPasswordFlow && !token) {
    title.textContent = "Link expired";
    subtitle.textContent = "";
    statusText.textContent = "This link has already been used. Please request a new one.";
    form.classList.add("hidden");
    statusScreen.classList.remove("hidden");
  }
  else if (!isPasswordFlow) {
    title.textContent = "Email verified";
    subtitle.textContent = "You can now return to the app.";
    form.classList.add("hidden");
    statusScreen.classList.remove("hidden");
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!isPasswordFlow || !token) return;

    const pw1 = pw1El.value.trim();
    const pw2 = pw2El.value.trim();

    if (pw1.length < 8 || pw1 !== pw2) {
      msg.textContent = "Passwords do not match.";
      return;
    }

    await fetch(`${SUPABASE_URL}/auth/v1/user`, {
      method: "PUT",
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ password: pw1 }),
    });

    msg.textContent = "✅ Password updated";
  });

  const pw1El = document.getElementById("pw1");
  const pw2El = document.getElementById("pw2");

  document.getElementById("clear").addEventListener("click", () => {
    pw1El.value = "";
    pw2El.value = "";
    msg.textContent = "";
  });
</script>
</body>
</html>
